name: Release

on:
  push:
    branches: [main]

jobs:
  release-please:
    runs-on: ubuntu-latest
    permissions: {}
    outputs:
      release_created: ${{ steps.release-please.outputs.release_created }}
      tag_name: ${{ steps.release-please.outputs.tag_name }}
    steps:
      - id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.PRIVATE_KEY }}
      - id: release-please
        uses: googleapis/release-please-action@v4
        with:
          token: ${{ steps.app-token.outputs.token }}

  publish-artifacts:
    needs: release-please
    if: needs.release-please.outputs.release_created
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      download_url: ${{ fromJSON(steps.publish-xpi.outputs.assets)[0].browser_download_url }}
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v6
        with:
          node-version-file: '.node-version'
          cache: 'npm'
      - run: npm ci
      - run: npm run verify
      - run: npm run build
      - run: npm run create-xpi
      - id: publish-xpi
        name: Publish xpi
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.release-please.outputs.tag_name }}
          files: xpi/*.xpi
      - name: Generate update manifest
        run: npm run generate-update-manifest -- ${{ fromJSON(steps.publish-xpi.outputs.assets)[0].browser_download_url }}
      - name: Publish update manifest
        uses: softprops/action-gh-release@v2
        with:
          tag_name: release
          files: gen/update*

  update-download-redirect:
    needs: publish-artifacts
    runs-on: ubuntu-latest
    permissions: {}
    steps:
      - name: Update download redirect
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
          CLOUDFLARE_RULESET_ID: ${{ secrets.CLOUDFLARE_RULESET_ID }}
          CLOUDFLARE_RULE_ID: ${{ secrets.CLOUDFLARE_RULE_ID }}
          DOWNLOAD_URL: ${{ needs.publish-artifacts.outputs.download_url }}
        run: |
          echo "Target URL: ${DOWNLOAD_URL}"
          PAYLOAD=$(jq --null-input \
            --arg download_url "${DOWNLOAD_URL}" \
            '{
              "action": "redirect",
              "action_parameters": {
                "from_value": {
                  "preserve_query_string": false,
                  "status_code": 302,
                  "target_url": {
                    "value": $download_url
                  }
                }
              },
              "description": "Notero download",
              "enabled": true,
              "expression": "(http.host eq \"notero.vanoni.dev\" and starts_with(http.request.uri.path, \"/download\"))"
            }')
          RESPONSE=$(curl --silent --show-error --fail-with-body --request PATCH \
            "https://api.cloudflare.com/client/v4/zones/${CLOUDFLARE_ZONE_ID}/rulesets/${CLOUDFLARE_RULESET_ID}/rules/${CLOUDFLARE_RULE_ID}" \
            --header "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
            --header "Content-Type: application/json" \
            --data "${PAYLOAD}")
          SUCCESS=$(echo "${RESPONSE}" | jq --raw-output '.success')
          if [ "${SUCCESS}" != "true" ]; then
            echo "‚ùå Cloudflare API request failed!"
            echo "Response: ${RESPONSE}"
            exit 1
          fi
