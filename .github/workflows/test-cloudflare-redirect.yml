name: Test Cloudflare Redirect

on:
  workflow_dispatch:
    inputs:
      download_url:
        description: 'Test download URL to redirect to'
        required: true
        type: string

jobs:
  test-redirect:
    runs-on: ubuntu-latest
    steps:
      - name: Update Cloudflare redirect
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
          CLOUDFLARE_RULESET_ID: ${{ secrets.CLOUDFLARE_RULESET_ID }}
          CLOUDFLARE_RULE_ID: ${{ secrets.CLOUDFLARE_RULE_ID }}
          DOWNLOAD_URL: ${{ inputs.download_url }}
        run: |
          echo "Testing Cloudflare redirect update..."
          echo "Target URL: ${DOWNLOAD_URL}"

          # Build JSON payload safely using jq
          PAYLOAD=$(jq --null-input \
            --arg download_url "${DOWNLOAD_URL}" \
            '{
              "action": "redirect",
              "action_parameters": {
                "from_value": {
                  "preserve_query_string": false,
                  "status_code": 302,
                  "target_url": {
                    "value": $download_url
                  }
                }
              },
              "description": "Notero download",
              "enabled": true,
              "expression": "(http.host eq \"notero.vanoni.dev\" and starts_with(http.request.uri.path, \"/download\"))"
            }')

          # Make API request and capture response
          RESPONSE=$(curl --silent --show-error --fail-with-body --request PATCH \
            "https://api.cloudflare.com/client/v4/zones/${CLOUDFLARE_ZONE_ID}/rulesets/${CLOUDFLARE_RULESET_ID}/rules/${CLOUDFLARE_RULE_ID}" \
            --header "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
            --header "Content-Type: application/json" \
            --data "${PAYLOAD}")

          # Parse and verify the response
          SUCCESS=$(echo "${RESPONSE}" | jq --raw-output '.success')

          if [ "${SUCCESS}" != "true" ]; then
            echo "❌ Cloudflare API request failed!"
            echo "Response: ${RESPONSE}"
            exit 1
          fi

          echo "✅ Redirect updated successfully!"
